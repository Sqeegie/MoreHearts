

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.logging.Logger;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.OfflinePlayer;
import org.bukkit.World;
import org.bukkit.command.Command;
import org.bukkit.command.CommandSender;
import org.bukkit.configuration.ConfigurationSection;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.plugin.PluginManager;
import org.bukkit.plugin.java.JavaPlugin;

public class MoreHearts extends JavaPlugin
{
  Logger log = Logger.getLogger("minecraft");
  HashMap<String, Double> perms = new HashMap();
  ArrayList<String> worlds = new ArrayList();
  String np = ChatColor.RED + "You don't have permission to use this command";
  double dh = 20.0D;
  boolean vh = false;
  
  public void onEnable()
  {
    log.info("[MoreHearts V2] Has been enabled!");
    Bukkit.getPluginManager().registerEvents(new PlayerListener(this), this);
    if (!getConfig().contains("Players"))
    {
      int rp = 1000 + (int)(Math.random() * 999999.0D);
      getConfig().createSection("Players");
      getConfig().createSection("Permissions");
      getConfig().set("DefaultHearts", Integer.valueOf(10));
      getConfig().set("EnableIn", ((World)Bukkit.getWorlds().get(0)).getName());
      getConfig().set("HideHearts", Boolean.valueOf(false));
      getConfig().set("ResetPassword", Integer.valueOf(rp));
      saveConfig();
    }
    dh = (getConfig().getDouble("DefaultHearts") * 2.0D);
    vh = getConfig().getBoolean("HideHearts");
    refperms();
    refworlds();
    Player[] arrayOfPlayer;
    int j = (arrayOfPlayer = Bukkit._INVALID_getOnlinePlayers()).length;
    for (int i = 0; i < j; i++)
    {
      Player o = arrayOfPlayer[i];
      
      refpl(o);
    }
  }
  
  public void onDisable()
  {
    log.info("[MoreHearts V2] Has been disabled!");
    Player[] arrayOfPlayer;
    int j = (arrayOfPlayer = Bukkit._INVALID_getOnlinePlayers()).length;
    for (int i = 0; i < j; i++)
    {
      Player p = arrayOfPlayer[i];
      
      getConfig().set("Players." + p.getUniqueId() + ".LastSeenAs", p.getName());
      getConfig().set("Players." + p.getUniqueId() + ".HP", Double.valueOf(p.getHealth()));
      p.setMaxHealth(20.0D);
    }
    String ws = (String)worlds.get(0);
    for (int a = 1; a < worlds.size(); a++) {
      ws = ws + "," + (String)worlds.get(a);
    }
    getConfig().set("EnableIn", ws);
    saveConfig();
  }
  
  public boolean onCommand(CommandSender s, Command cmd, String command, String[] args)
  {
    if (command.equalsIgnoreCase("hearts")) {
      if ((s instanceof Player))
      {
        if (!s.hasPermission("morehearts.hearts"))
        {
          s.sendMessage(np);
          return false;
        }
        Player p = (Player)s;
        s.sendMessage(ChatColor.AQUA + "You have " + ChatColor.GREEN + p.getHealth() / 2.0D + ChatColor.AQUA + "/" + ChatColor.GREEN + p.getMaxHealth() / 2.0D + ChatColor.AQUA + " hearts!");
      }
    }
    if ((command.equalsIgnoreCase("mh")) || (command.equalsIgnoreCase("morehearts"))) {
      if (args.length == 0)
      {
        if (!s.hasPermission("morehearts.help"))
        {
          s.sendMessage(np);
          return false;
        }
        sendMessages(s, ChatColor.GREEN + "MoreHearts V2 help:;" + 
          ChatColor.AQUA + "<> - Required " + ChatColor.GREEN + "[] - Optional;" + 
          ChatColor.AQUA + "/mh refresh -" + ChatColor.GREEN + " reload config;" + 
          ChatColor.AQUA + "/mh add <player> <amount> - " + ChatColor.GREEN + "Add hearts to a player;" + 
          ChatColor.AQUA + "/mh set <player> <amount> - " + ChatColor.GREEN + "Set hearts for a player;" + 
          ChatColor.AQUA + "/mh addworld [world] - " + ChatColor.GREEN + "Enable MoreHearts in a world;" + 
          ChatColor.AQUA + "/mh addallworlds - " + ChatColor.GREEN + "Will enable morehearts in every loaded world;" + 
          ChatColor.AQUA + "/mh removeworld [world] - " + ChatColor.GREEN + "Remove a world;" + 
          ChatColor.AQUA + "/mh worlds - " + ChatColor.GREEN + "All world that MoreHearts is enabled in;" + 
          ChatColor.AQUA + "/mh reset <Password> - " + ChatColor.GREEN + "Delete config;" + 
          ChatColor.AQUA + "/hearts - " + ChatColor.GREEN + "Check your real health (useful only if HideHearts is off");
      }
      else
      {
        Object localObject;
        Player o;
        if (args.length == 1)
        {
          if (!s.hasPermission("morehearts." + args[0].toLowerCase()))
          {
            s.sendMessage(np);
            return false;
          }
          String str;
          if (args[0].equalsIgnoreCase("worlds"))
          {
            boolean b = true;
            s.sendMessage(ChatColor.GREEN + "MoreHearts is enabled in:");
            for (Iterator localIterator = worlds.iterator(); localIterator.hasNext();)
            {
              str = (String)localIterator.next();
              if (b) {
                s.sendMessage(ChatColor.AQUA + "- " + str);
              } else {
                s.sendMessage(ChatColor.GREEN + "- " + str);
              }
              b = !b;
            }
          }
          else if (args[0].equalsIgnoreCase("refresh"))
          {
            reloadConfig();
            refperms();
            refworlds();
            Player[] arrayOfPlayer1;
            String str1 = (arrayOfPlayer1 = Bukkit._INVALID_getOnlinePlayers()).length;
            for (str = 0; str < str1; str++)
            {
              Player o = arrayOfPlayer1[str];
              
              refpl(o);
            }
            s.sendMessage(ChatColor.GREEN + "Everything has been refreshed!");
          }
          else
          {
            Player[] arrayOfPlayer2;
            Player localPlayer1;
            if (args[0].equalsIgnoreCase("addworld"))
            {
              if ((s instanceof Player))
              {
                Player p = (Player)s;
                if (!worlds.contains(p.getWorld().getName()))
                {
                  worlds.add(p.getWorld().getName());
                  p.sendMessage(ChatColor.GREEN + "The world '" + ChatColor.GREEN + p.getWorld().getName() + ChatColor.AQUA + "' has been added!");
                  Player localPlayer3 = (arrayOfPlayer2 = Bukkit._INVALID_getOnlinePlayers()).length;
                  for (localPlayer1 = 0; localPlayer1 < localPlayer3; localPlayer1++)
                  {
                    Player o = arrayOfPlayer2[localPlayer1];
                    
                    refpl(o);
                  }
                  saveworlds();
                }
                else
                {
                  p.sendMessage(ChatColor.RED + "MoreHearts is already enabled in this world");
                }
              }
            }
            else if (args[0].equalsIgnoreCase("removeworld"))
            {
              if ((s instanceof Player))
              {
                Player p = (Player)s;
                if (worlds.contains(p.getWorld().getName()))
                {
                  worlds.remove(p.getWorld().getName());
                  p.sendMessage(ChatColor.GREEN + "MoreHearts is no longer enabled in the world '" + ChatColor.GREEN + p.getWorld().getName() + ChatColor.AQUA + "'");
                  localObject = (arrayOfPlayer2 = Bukkit._INVALID_getOnlinePlayers()).length;
                  for (localPlayer1 = 0; localPlayer1 < localObject; localPlayer1++)
                  {
                    o = arrayOfPlayer2[localPlayer1];
                    
                    refpl(o);
                  }
                  saveworlds();
                }
                else
                {
                  p.sendMessage(ChatColor.RED + "MoreHearts is not enabled in this world");
                }
              }
            }
            else if (args[0].equalsIgnoreCase("addallworlds"))
            {
              for (World w : Bukkit.getWorlds())
              {
                if (!worlds.contains(w.getName())) {
                  worlds.add(w.getName());
                }
                saveworlds();
              }
              localPlayer1 = (localObject = Bukkit._INVALID_getOnlinePlayers()).length;
              for (o = 0; o < localPlayer1; o++)
              {
                Player o = localObject[o];
                
                refpl(o);
              }
              s.sendMessage(ChatColor.GREEN + "MoreHearts has been enabled in every loaded world!");
            }
            else if (args[0].equalsIgnoreCase("reset"))
            {
              s.sendMessage(ChatColor.RED + "Usage: /mh reset <Password>");
            }
            else if (args[0].equalsIgnoreCase("add"))
            {
              s.sendMessage(ChatColor.RED + "Usage: /mh add <Player> <Amount>");
            }
            else if (args[0].equalsIgnoreCase("set"))
            {
              s.sendMessage(ChatColor.RED + "Usage: /mh set <Player> <Amount>");
            }
            else
            {
              s.sendMessage(ChatColor.RED + "Unknown command.");
            }
          }
        }
        else if (args.length == 2)
        {
          if (!s.hasPermission("morehearts." + args[0].toLowerCase())) {
            s.sendMessage(np);
          } else if (args[0].equalsIgnoreCase("refresh")) {
            s.sendMessage(ChatColor.RED + "Usage: /mh refresh");
          } else if (args[0].equalsIgnoreCase("add")) {
            s.sendMessage(ChatColor.RED + "Usage: /mh add <Player> <amount>");
          } else if (args[0].equalsIgnoreCase("set")) {
            s.sendMessage(ChatColor.RED + "Usage: /mh set <Player <Amount>");
          } else if (args[0].equalsIgnoreCase("addworld"))
          {
            if (!worlds.contains(args[1]))
            {
              worlds.add(args[1]);
              saveworlds();
              s.sendMessage(ChatColor.GREEN + "MoreHearts has been enabled in the world '" + ChatColor.AQUA + args[1] + ChatColor.GREEN + "'");
            }
            else
            {
              s.sendMessage(ChatColor.GREEN + "MoreHearts is already disabled in the world '" + ChatColor.AQUA + "'");
            }
          }
          else if (args[0].equalsIgnoreCase("addallworlds")) {
            s.sendMessage(ChatColor.RED + "Usage: /mh addallworlds");
          } else if (args[0].equalsIgnoreCase("removeworld"))
          {
            if (worlds.contains(args[1]))
            {
              worlds.remove(args[1]);
              saveworlds();
              s.sendMessage(ChatColor.GREEN + "MoreHearts has been disabled in the world '" + ChatColor.AQUA + args[1] + ChatColor.GREEN + "'");
            }
            else
            {
              s.sendMessage(ChatColor.GREEN + "MoreHearts is already disabled in the world '" + ChatColor.AQUA + "'");
            }
          }
          else if (args[0].equalsIgnoreCase("worlds")) {
            s.sendMessage(ChatColor.RED + "Usage: /mh worlds");
          } else if (args[0].equalsIgnoreCase("reset"))
          {
            if (args[1].equals(getConfig().getString("ResetPassword")))
            {
              getConfig().set("Players", null);
              getConfig().set("Permissions", null);
              getConfig().set("DefaultHearts", Integer.valueOf(10));
              getConfig().set("EnableIn", Bukkit.getWorlds().get(0));
              getConfig().set("HideHearts", Boolean.valueOf(true));
              saveConfig();
              refperms();
              refworlds();
              Player localPlayer2 = (localObject = Bukkit._INVALID_getOnlinePlayers()).length;
              for (o = 0; o < localPlayer2; o++)
              {
                Player o = localObject[o];
                
                refpl(o);
              }
              s.sendMessage(ChatColor.GREEN + "Config has been reseted!");
            }
            else
            {
              s.sendMessage(ChatColor.RED + "Incorrect Password");
            }
          }
          else {
            s.sendMessage(ChatColor.RED + "Unknown Command");
          }
        }
        else if (args.length == 3)
        {
          if (!s.hasPermission("morehearts." + args[0].toLowerCase()))
          {
            s.sendMessage(np);
          }
          else if (args[0].equalsIgnoreCase("refresh"))
          {
            s.sendMessage(ChatColor.RED + "Usage: /mh refresh");
          }
          else if (args[0].equalsIgnoreCase("add"))
          {
            OfflinePlayer opl = Bukkit.getOfflinePlayer(args[1]);
            if (!opl.isOnline())
            {
              s.sendMessage(ChatColor.RED + "The player '" + args[1] + "' isn't online!");
            }
            else
            {
              Player p = (Player)opl;
              double d = Double.parseDouble(args[2]);
              double eh = getConfig().getDouble("Players." + p.getUniqueId() + ".ExtraHearts");
              getConfig().set("Players." + p.getUniqueId() + ".ExtraHearts", Double.valueOf(eh + d));
              saveConfig();
              refpl(p);
              s.sendMessage("" + ChatColor.GREEN + d + " hearts has been added to " + p.getName());
            }
          }
          else if (args[0].equalsIgnoreCase("set"))
          {
            OfflinePlayer opl = Bukkit.getOfflinePlayer(args[1]);
            if (!opl.isOnline())
            {
              s.sendMessage(ChatColor.RED + "The player '" + args[1] + "' isn't online!");
            }
            else
            {
              Player p = (Player)opl;
              double d = Double.parseDouble(args[2]);
              getConfig().set("Players." + p.getUniqueId() + ".ExtraHearts", Double.valueOf(d));
              saveConfig();
              refpl(p);
              s.sendMessage(ChatColor.GREEN + p.getName() + "Extra hearts set to " + d);
            }
          }
          else if (args[0].equalsIgnoreCase("addworld"))
          {
            s.sendMessage(ChatColor.RED + "Usage: /mh addworld [world]");
          }
          else if (args[0].equalsIgnoreCase("addallworlds"))
          {
            s.sendMessage(ChatColor.RED + "Usage: /mh addallworlds");
          }
          else if (args[0].equalsIgnoreCase("removeworld"))
          {
            s.sendMessage(ChatColor.RED + "Usage: /mh removeworld [world]");
          }
          else if (args[0].equalsIgnoreCase("worlds"))
          {
            s.sendMessage(ChatColor.RED + "Usage: /mh worlds");
          }
          else if (args[0].equalsIgnoreCase("reset"))
          {
            s.sendMessage(ChatColor.RED + "Usage: /mh reset <Password>");
          }
          else
          {
            s.sendMessage(ChatColor.RED + "Unknown Command");
          }
        }
        else if (!s.hasPermission("morehearts." + args[0].toLowerCase()))
        {
          s.sendMessage(np);
        }
        else if (args[0].equalsIgnoreCase("refresh"))
        {
          s.sendMessage(ChatColor.RED + "Usage: /mh refresh");
        }
        else if (args[0].equalsIgnoreCase("add"))
        {
          s.sendMessage(ChatColor.RED + "Usage: /mh add <Player> <Amount>");
        }
        else if (args[0].equalsIgnoreCase("set"))
        {
          s.sendMessage(ChatColor.RED + "Usage: /mh set <Player> <Amount>");
        }
        else if (args[0].equalsIgnoreCase("addworld"))
        {
          s.sendMessage(ChatColor.RED + "Usage: /mh addworld [world]");
        }
        else if (args[0].equalsIgnoreCase("addallworlds"))
        {
          s.sendMessage(ChatColor.RED + "Usage: /mh addallworlds");
        }
        else if (args[0].equalsIgnoreCase("removeworld"))
        {
          s.sendMessage(ChatColor.RED + "Usage: /mh removeworld [world]");
        }
        else if (args[0].equalsIgnoreCase("worlds"))
        {
          s.sendMessage(ChatColor.RED + "Usage: /mh worlds");
        }
        else if (args[0].equalsIgnoreCase("reset"))
        {
          s.sendMessage(ChatColor.RED + "Usage: /mh reset <Password>");
        }
        else
        {
          s.sendMessage(ChatColor.RED + "Unknown Command");
        }
      }
    }
    return false;
  }
  
  public void refpl(Player p)
  {
    double sum = dh;
    if (worlds.contains(p.getWorld().getName()))
    {
      if (getConfig().contains("Players." + p.getUniqueId() + ".ExtraHearts"))
      {
        sum += getConfig().getDouble("Players." + p.getUniqueId() + ".ExtraHearts") * 2.0D;
      }
      else
      {
        getConfig().set("Players." + p.getUniqueId() + ".ExtraHearts", Integer.valueOf(0));
        saveConfig();
      }
      for (String str : perms.keySet()) {
        if (p.isPermissionSet(str)) {
          sum += ((Double)perms.get(str)).doubleValue();
        }
      }
      p.setMaxHealth(sum);
      p.setHealthScaled(false);
      if (!p.isDead())
      {
        double hp = getConfig().getDouble("Players." + p.getUniqueId() + ".HP");
        if (hp == 0.0D) {
          p.setHealth(sum);
        } else if (hp > sum) {
          p.setHealth(sum);
        } else {
          p.setHealth(hp);
        }
      }
    }
    else
    {
      p.setMaxHealth(20.0D);
    }
  }
  
  public void refperms()
  {
    perms.clear();
    for (String str : getConfig().getConfigurationSection("Permissions").getKeys(false)) {
      perms.put("morehearts." + str, Double.valueOf(getConfig().getDouble("Permissions." + str) * 2.0D));
    }
  }
  
  public void saveworlds()
  {
    String ws = (String)worlds.get(0);
    for (int a = 1; a < worlds.size(); a++) {
      ws = ws + "," + (String)worlds.get(a);
    }
    getConfig().set("EnableIn", ws);
    saveConfig();
  }
  
  public void refworlds()
  {
    String ws = getConfig().getString("EnableIn");
    String[] Eworlds = ws.split(",");
    String[] arrayOfString1;
    int j = (arrayOfString1 = Eworlds).length;
    for (int i = 0; i < j; i++)
    {
      String str = arrayOfString1[i];
      
      worlds.add(str);
    }
  }
  
  public void sendMessages(CommandSender p, String s)
  {
    String[] msgs = s.split(";");
    String[] arrayOfString1;
    int j = (arrayOfString1 = msgs).length;
    for (int i = 0; i < j; i++)
    {
      String str = arrayOfString1[i];
      
      p.sendMessage(str);
    }
  }
}
