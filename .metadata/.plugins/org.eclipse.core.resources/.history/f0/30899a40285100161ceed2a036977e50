package com.roei12.mh2;

import java.util.ArrayList;
import org.bukkit.Bukkit;
import org.bukkit.World;
import org.bukkit.configuration.file.FileConfiguration;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.entity.EntityDamageEvent;
import org.bukkit.event.entity.EntityRegainHealthEvent;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerKickEvent;
import org.bukkit.event.player.PlayerQuitEvent;
import org.bukkit.event.player.PlayerTeleportEvent;
import org.bukkit.scheduler.BukkitScheduler;

public class PlayerListener
  implements Listener
{
  private MoreHearts plugin;
  
  public PlayerListener(MoreHearts pl)
  {
    plugin = pl;
  }
  
  @EventHandler
  public void pje(PlayerJoinEvent e)
  {
    Player p = e.getPlayer();
    if (!plugin.getConfig().contains("Players." + p.getUniqueId()))
    {
      plugin.getConfig().set("Players." + p.getUniqueId() + ".LastSeenAs", p.getName());
      plugin.getConfig().set("Players." + p.getUniqueId() + ".HP", Double.valueOf(p.getHealth()));
      plugin.getConfig().set("Players." + p.getUniqueId() + ".ExtraHearts", Integer.valueOf(0));
      plugin.saveConfig();
    }
    plugin.refpl(p);
  }
  
  @EventHandler
  public void pqe(PlayerQuitEvent e)
  {
    Player p = e.getPlayer();
    plugin.getConfig().set("Players." + p.getUniqueId() + ".LastSeenAs", p.getName());
    if (plugin.worlds.contains(p.getWorld().getName())) {
      plugin.getConfig().set("Players." + p.getUniqueId() + ".HP", Double.valueOf(p.getHealth()));
    }
    plugin.saveConfig();
    p.setMaxHealth(20.0D);
  }
  
  @EventHandler
  public void pke(PlayerKickEvent e)
  {
    Player p = e.getPlayer();
    plugin.getConfig().set("Players." + p.getUniqueId() + ".LastSeenAs", p.getName());
    if (plugin.worlds.contains(p.getWorld().getName())) {
      plugin.getConfig().set("Players." + p.getUniqueId() + ".HP", Double.valueOf(p.getHealth()));
    }
    plugin.saveConfig();
    p.setMaxHealth(20.0D);
  }
  
  @EventHandler
  public void pte(PlayerTeleportEvent e)
  {
    final Player p = e.getPlayer();
    if (plugin.worlds.contains(p.getWorld().getName()))
    {
      plugin.getConfig().set("Players." + p.getUniqueId() + ".HP", Double.valueOf(p.getHealth()));
      plugin.saveConfig();
    }
    Bukkit.getScheduler().scheduleSyncDelayedTask(plugin, new Runnable()
    {
      public void run()
      {
        plugin.refpl(p);
      }
    }, 1L);
  }
  
  @EventHandler
  public void hre(EntityRegainHealthEvent e)
  {
    if ((e.getEntity() instanceof Player))
    {
      Player p = (Player)e.getEntity();
      if (plugin.worlds.contains(p.getWorld().getName()))
      {
        plugin.getConfig().set("Players." + p.getUniqueId() + ".HP", Double.valueOf(p.getHealth()));
        plugin.saveConfig();
      }
    }
  }
  
  @EventHandler
  public void pde(EntityDamageEvent e)
  {
    if ((e.getEntity() instanceof Player))
    {
      Player p = (Player)e.getEntity();
      if (plugin.worlds.contains(p.getWorld().getName()))
      {
        plugin.getConfig().set("Players." + p.getUniqueId() + ".HP", Double.valueOf(p.getHealth()));
        plugin.saveConfig();
      }
    }
  }
}